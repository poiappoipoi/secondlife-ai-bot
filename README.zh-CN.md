# Second Life AI æœºå™¨äºº

**[ç®€ä½“ä¸­æ–‡](#ç®€ä½“ä¸­æ–‡) | [English](README.md#english)**

---

## ç®€ä½“ä¸­æ–‡

ä¸€ä¸ªç”± X.AI çš„ Grok API æˆ–æœ¬åœ° LLM é©±åŠ¨çš„ Second Life æ™ºèƒ½èŠå¤©æœºå™¨äººã€‚è¯¥æœºå™¨äººé‡‡ç”¨ NPC çŠ¶æ€æœºï¼Œä½¿å…¶æœ‰é€‰æ‹©æ€§åœ°å“åº”ï¼Œåˆ›é€ æ›´åƒçœŸå®žè§’è‰²çš„äº¤äº’ä½“éªŒã€‚

### åŠŸèƒ½

- ðŸ¤– **å¤šä¸ª AI æä¾›å•†** - æ”¯æŒ X.AI Grok å’Œæœ¬åœ° Ollama
- ðŸ§  **NPC çŠ¶æ€æœº** - æœ‰é€‰æ‹©æ€§çš„å“åº”è¡Œä¸ºï¼Œä¸æ˜¯ç®€å•çš„èŠå¤©æœºå™¨äºº
- ðŸ’­ **å¯¹è¯è®°å¿†** - å…·æœ‰å¯é…ç½®åŽ†å²çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥å“åº”
- ðŸ“š **äººç‰©è®¾å®šç³»ç»Ÿ** - ä»Ž markdown æ–‡ä»¶åŠ è½½è§’è‰²å®šä¹‰
- ðŸŽ¯ **è®°å¿†å…³é”®è¯** - å…³é”®å­—æ¿€æ´»çš„è®°å¿†æ³¨å…¥ï¼ˆçµæ„Ÿæ¥è‡ª SillyTavern çš„ Lorebookï¼‰
- ðŸ“Š **æµé‡é™åˆ¶** - å¯é…ç½®çš„è¯·æ±‚é™åˆ¶ï¼ˆé»˜è®¤ï¼š40/å°æ—¶ï¼‰
- ðŸ“ **æ—¥å¿—è®°å½•** - è‡ªåŠ¨å¯¹è¯æ—¥å¿—è®°å½•ï¼Œæ”¯æŒæ—¶åŒº
- ðŸŽ® **LSL é›†æˆ** - å¸¦æœ‰è§¦æ‘¸èœå•æŽ§åˆ¶çš„ Second Life ç‰©ä½“è„šæœ¬
- ðŸ” **OOC è¿‡æ»¤** - è‡ªåŠ¨å¿½ç•¥è§’è‰²å¤–æ¶ˆæ¯ `((...))`
- â¸ï¸ **æš‚åœ/æ¢å¤** - æŽ§åˆ¶æœºå™¨äººç›‘å¬çŠ¶æ€

### å¿«é€Ÿå¼€å§‹

#### å‰ç½®è¦æ±‚

- [Bun.js](https://bun.sh)ï¼ˆv1.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
- æ¥è‡ª [x.ai](https://x.ai) çš„ X.AI API å¯†é’¥
- Second Life è´¦æˆ·

#### å®‰è£…

1. **å…‹éš†ä»“åº“**

```bash
git clone https://github.com/poiappoipoi/secondlife-ai-bot.git
cd secondlife-ai-bot/server
```

2. **å®‰è£…ä¾èµ–**

```bash
bun install
```

3. **é…ç½®çŽ¯å¢ƒ**

å»ºè®®ç›´æŽ¥åˆ›å»ºä¸€ä¸ª `.env.local` æ¥è¦†ç›–æœ¬åœ°éœ€è¦çš„å€¼ï¼š

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env.local`ï¼Œç¤ºä¾‹å†…å®¹ï¼š

```bash
# åˆ›å»ºæ–‡ä»¶ï¼ˆåœ¨ Unix shell ä¸‹ï¼‰
cat > .env.local <<'EOF'
# æœåŠ¡å™¨
PORT=3002

# AI æä¾›å•† (xai | ollama)
AI_PROVIDER=xai
XAI_API_KEY=ä½ çš„-xai-api-å¯†é’¥
EOF
```

æœåŠ¡å™¨ä¼šè¯»å–ä»“åº“ä¸­çš„é»˜è®¤ `.env`ï¼Œå¹¶å°† `.env.local` ä¸­çš„å€¼ä½œä¸ºæœ¬åœ°è¦†ç›–ï¼Œè¿™æ ·å¯ä»¥é¿å…å°†å¯†é’¥æäº¤åˆ°ä»“åº“ã€‚

#### å¿«é€Ÿå¯åŠ¨ â€” X.AI (Grok) æ¨¡å¼

åˆ›å»ºæˆ–æ›´æ–°ä¸€ä¸ªæœ€å°çš„ `.env.local`ï¼Œç„¶åŽä»¥ X.AI æ¨¡å¼å¯åŠ¨æœåŠ¡å™¨ï¼š

```bash
cat > .env.local <<'EOF'
PORT=3002
AI_PROVIDER=xai
XAI_API_KEY=ä½ çš„-xai-api-å¯†é’¥
EOF

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
bun run dev
```

4. **å¯åŠ¨æœåŠ¡å™¨**

```bash
bun run dev          # å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡æ–°åŠ è½½ï¼‰
bun run start        # ç”Ÿäº§æ¨¡å¼
```

æœåŠ¡å™¨é»˜è®¤åœ¨ç«¯å£ 3002 å¯åŠ¨ã€‚

### åœ¨ Second Life ä¸­è®¾ç½®

1. å¤åˆ¶ `lsl/brain.lsl` çš„å†…å®¹
2. åœ¨ Second Life ç‰©ä½“ä¸­åˆ›å»ºæ–°è„šæœ¬
3. ç²˜è´´å¹¶ä¿®æ”¹é…ç½®ï¼š

```lsl
string url_base = "ä½ çš„æœåŠ¡å™¨åœ°å€";
```

**å¦‚æžœä½¿ç”¨ Cloudflare éš§é“ï¼ˆæŽ¨èï¼‰ï¼š**
```lsl
string url_base = "https://random-name.trycloudflare.com";
```

**å¦‚æžœä½¿ç”¨ç›´æŽ¥ IPï¼š**
```lsl
string url_base = "http://ä½ çš„æœåŠ¡å™¨IP:3002";
```

4. ä¿å­˜å¹¶é‡ç½®è„šæœ¬
5. è§¦æ‘¸ç‰©ä½“æŸ¥çœ‹èœå•

### èœå•æŽ§åˆ¶

- **è¨­å®šäººè¨­** - æ›´æ”¹ AI çš„äººç‰©è®¾å®š
- **æ¸…é™¤è¨˜æ†¶** - é‡ç½®å¯¹è¯åŽ†å²
- **é–‹å•Ÿ/æš«åœ** - åˆ‡æ¢ç›‘å¬çŠ¶æ€

### é¡¹ç›®ç»“æž„

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # å…¥å£ç‚¹
â”‚   â”œâ”€â”€ app.ts                # Express åº”ç”¨è®¾ç½®
â”‚   â”œâ”€â”€ config/               # ç±»åž‹å®‰å…¨çš„é…ç½®
â”‚   â”œâ”€â”€ types/                # TypeScript å®šä¹‰
â”‚   â”œâ”€â”€ providers/            # AI æä¾›å•†å®žçŽ°
â”‚   â”‚   â”œâ”€â”€ base.ts           # åŸºç¡€æä¾›å•†ç±»
â”‚   â”‚   â”œâ”€â”€ xai.ts            # X.AI Grok æä¾›å•†
â”‚   â”‚   â””â”€â”€ ollama.ts         # Ollama æä¾›å•†
â”‚   â”œâ”€â”€ services/             # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ conversation.ts   # æ¶ˆæ¯åŽ†å²
â”‚   â”‚   â”œâ”€â”€ decision-layer.ts # NPC å†³ç­–åˆ¶å®š
â”‚   â”‚   â”œâ”€â”€ state-machine.ts  # NPC çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ message-buffer.ts # æ¯ä¸ªå¤´åƒçš„ç¼“å†²
â”‚   â”‚   â”œâ”€â”€ memory.ts         # å…³é”®å­—è®°å¿†ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ rate-limiter.ts   # è¯·æ±‚é™åˆ¶
â”‚   â”‚   â”œâ”€â”€ logger.ts         # æ–‡ä»¶æ—¥å¿—
â”‚   â”‚   â””â”€â”€ persona.ts        # äººç‰©è®¾å®šåŠ è½½
â”‚   â”œâ”€â”€ routes/               # API ç«¯ç‚¹
â”‚   â”‚   â”œâ”€â”€ chat.ts           # POST /chat
â”‚   â”‚   â””â”€â”€ memory.ts         # POST /memory/reset
â”‚   â”œâ”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ __tests__/            # å•å…ƒæµ‹è¯•
â”œâ”€â”€ personas/                 # äººç‰©è®¾å®š markdown æ–‡ä»¶
â”‚   â””â”€â”€ cat-maid.md           # ç¤ºä¾‹äººç‰©è®¾å®š
â””â”€â”€ logs/                     # å¯¹è¯æ—¥å¿—ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
```

### API ç«¯ç‚¹

#### POST `/chat`

å‘ AI æœºå™¨äººå‘é€æ¶ˆæ¯ã€‚

**è¯·æ±‚ï¼š**
```json
{
  "speaker": "John Doe",
  "message": "ä½ å¥½ï¼Œä½ å¥½å—ï¼Ÿ",
  "avatarId": "uuid-å¯é€‰"
}
```

**å“åº”ï¼š**
- `200 OK` - AI çš„çº¯æ–‡æœ¬å“åº”
- `202 Accepted` - NPC æ”¶åˆ°æ¶ˆæ¯ä½†é€‰æ‹©ä¸å“åº”
- `429 Too Many Requests` - è¶…è¿‡é€ŸçŽ‡é™åˆ¶

#### POST `/memory/reset`

æ¸…é™¤å¯¹è¯åŽ†å²å¹¶ä¿å­˜åˆ°æ—¥å¿—ã€‚

**å“åº”ï¼š**
- `204 No Content` - æˆåŠŸ

### é…ç½®

çŽ¯å¢ƒå˜é‡ï¼ˆé»˜è®¤åœ¨ `.env` ä¸­ï¼‰ã€‚å»ºè®®åœ¨æœ¬åœ°ä½¿ç”¨ `.env.local` è¦†ç›–ï¼š

```env
# æœåŠ¡å™¨
PORT=3002
NODE_ENV=development

# AI æä¾›å•†
AI_PROVIDER=xai                    # xai æˆ– ollama
AI_MAX_TOKENS=300
AI_TIMEOUT_MS=30000

# X.AI Grok
XAI_API_KEY=sk-...
XAI_MODEL=grok-4-1-fast-non-reasoning

# Ollamaï¼ˆæœ¬åœ° LLMï¼‰
OLLAMA_BASE_URL=http://localhost:11434/v1
OLLAMA_MODEL=cat-maid

# æµé‡é™åˆ¶
RATE_LIMIT_MAX=40
RATE_LIMIT_WINDOW_MS=3600000      # 1 å°æ—¶

# å¯¹è¯
CONVERSATION_MAX_HISTORY_MESSAGES=50
INACTIVITY_TIMEOUT_MS=3600000

# äººç‰©è®¾å®š
PERSONA_FILE=cat-maid.md
PERSONAS_DIR=./personas

# NPC çŠ¶æ€æœºï¼ˆå¯é€‰ï¼‰
NPC_ENABLED=true
NPC_TICK_INTERVAL_MS=1000
NPC_LISTENING_TIMEOUT_MS=15000
NPC_RESPONSE_THRESHOLD=50
NPC_RESPONSE_CHANCE=0.8
NPC_TRIGGER_WORDS=maid,cat-maid

# æ—¥å¿—
LOG_LEVEL=info
LOG_TIMEZONE=UTC
```

### åˆ›å»ºè‡ªå®šä¹‰äººç‰©è®¾å®š

äººç‰©è®¾å®šæ–‡ä»¶æ˜¯ `personas/` ç›®å½•ä¸­çš„ markdown æ–‡ä»¶ã€‚ç¤ºä¾‹ç»“æž„ï¼š

```markdown
# ç³»ç»Ÿæç¤º

ä½ æ˜¯ä¸€ä¸ªæœ‰å¸®åŠ©ä¸”å‹å¥½çš„ AI åŠ©æ‰‹ã€‚
ä½ å–œæ¬¢å¸®åŠ©äººä»¬ï¼Œæ€»æ˜¯ç¤¼è²Œåœ°å›žåº”ã€‚

### æ€§æ ¼ç‰¹å¾

- å‹å¥½ä¸”å¹³æ˜“è¿‘äºº
- å¯¹ Second Life æœ‰äº†è§£
- è€å¿ƒè§£ç­”é—®é¢˜

### ä¸–ç•ŒèƒŒæ™¯

è¿™æ¬¡å¯¹è¯å‘ç”Ÿåœ¨ Second Lifeï¼Œä¸€ä¸ªè™šæ‹ŸçŽ°å®žå¹³å°ã€‚
```

ç³»ç»Ÿæç¤ºï¼ˆç¬¬ä¸€ä¸ª `###` ä¹‹å‰ï¼‰è¢«ç”¨ä½œ AI çš„æŒ‡ä»¤ã€‚ä»¥ `###` å¼€å¤´çš„éƒ¨åˆ†è¢«è§£æžä¸ºäººç‰©è®¾å®šäº‹å®žã€‚

### å¼€å‘å‘½ä»¤

```bash
# å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡æ–°åŠ è½½ï¼‰
bun run dev

# ç”Ÿäº§æœåŠ¡å™¨
bun run start

# ç±»åž‹æ£€æŸ¥
bun run typecheck
bun run typecheck:watch

# ä»£ç æ£€æŸ¥
bun run lint
bun run lint:fix

# ä»£ç æ ¼å¼åŒ–
bun run format
bun run format:check

# æµ‹è¯•
bun test
bun test:watch

# è´¨é‡æ£€æŸ¥ï¼ˆæ‰€æœ‰æ£€æŸ¥ä¸€æ¬¡ï¼‰
npm run check
```

### NPC çŠ¶æ€æœº

æœºå™¨äººä½¿ç”¨å¯é€‰çš„çŠ¶æ€æœºä½¿å…¶æ›´åƒ NPCï¼š

1. **IDLE** - ç­‰å¾…æ¶ˆæ¯
2. **LISTENING** - ä»Žå¤´åƒæ”¶é›†æ¶ˆæ¯
3. **THINKING** - å¤„ç†å¹¶å†³å®šæ˜¯å¦å“åº”
4. **SPEAKING** - ç”Ÿæˆ AI å“åº”

**å†³ç­–å› ç´ ï¼š**
- ç›´æŽ¥æåŠï¼ˆç”±å…³é”®è¯è§¦å‘ï¼‰
- æœ€è¿‘äº¤äº’åŽ†å²
- æ¶ˆæ¯é¢‘çŽ‡
- éšæœºå› ç´ ï¼ˆä¸å¯é¢„æµ‹æ€§ï¼‰
- å¤´åƒå†·å´æ—¶é—´ï¼ˆé˜²æ­¢åžƒåœ¾é‚®ä»¶ï¼‰

### æ•…éšœæŽ’é™¤

**æœåŠ¡å™¨æ— æ³•å¯åŠ¨**
- æ£€æŸ¥ç«¯å£ 3002 æ˜¯å¦å·²è¢«ä½¿ç”¨ï¼š`lsof -i :3002`
- éªŒè¯ `.env` æˆ– `.env.local` åŒ…å«æœ‰æ•ˆçš„ API å¯†é’¥
- æ£€æŸ¥ Bun å®‰è£…ï¼š`bun --version`

**æœºå™¨äººåœ¨ Second Life ä¸­æ— å“åº”**
- éªŒè¯ `brain.lsl` ä¸­çš„ `url_base` ä¸Žä½ çš„æœåŠ¡å™¨ URL åŒ¹é…
- æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼š`cat logs/chat_*.log`
- ç¡®ä¿æœºå™¨äººæœªæš‚åœï¼ˆæ£€æŸ¥ç‰©ä½“ä¸Šæ–¹çš„æµ®åŠ¨æ–‡æœ¬ï¼‰
- éªŒè¯æ˜¯å¦è¶…è¿‡äº†é€ŸçŽ‡é™åˆ¶
- æ£€æŸ¥åˆ°æœåŠ¡å™¨çš„ç½‘ç»œè¿žæŽ¥

**é«˜å»¶è¿Ÿæˆ–è¶…æ—¶**
- å¢žåŠ  `.env` ä¸­çš„ `AI_TIMEOUT_MS`
- æ£€æŸ¥ LLM æä¾›å•†æ˜¯å¦å“åº”ç¼“æ…¢
- å‡å°‘ `AI_MAX_TOKENS` ä»¥åŠ å¿«å“åº”

### æœåŠ¡å™¨éš§é“

è¦å°†æœ¬åœ°æœåŠ¡å™¨æš´éœ²åˆ° Second Lifeï¼Œè¯·ä½¿ç”¨ Cloudflare éš§é“ï¼š

```bash
# å®‰è£… cloudflared
# macOS: brew install cloudflare-cli
# Windows: choco install cloudflare-warp
# Linux: wget https://github.com/cloudflare/warp-cli/releases/download/v1.0.0/warp-cli-linux-x86_64.zip

cloudflared tunnel --url http://localhost:3002
```

è¯¦è§ [CLOUDFLARE_TUNNEL.md](CLOUDFLARE_TUNNEL.md)ã€‚

### æ—¥å¿—

å¯¹è¯æ—¥å¿—è‡ªåŠ¨ä¿å­˜åˆ° `logs/` ç›®å½•ï¼Œæ–‡ä»¶åå¦‚ï¼š
```
chat_2025-01-27_14-30-45.log
```

æ—¥å¿—åŒ…å«æ—¶åŒºä¿¡æ¯ï¼ˆé€šè¿‡ `LOG_TIMEZONE` é…ç½®ï¼‰ã€‚

### è®¸å¯è¯

æ­¤é¡¹ç›®ä¸ºå¼€æºé¡¹ç›®ã€‚æ¬¢è¿Žæ ¹æ®éœ€è¦ä¿®æ”¹å’Œä½¿ç”¨ã€‚

### è´¡çŒ®

æ¬¢è¿Žè´¡çŒ®ï¼è¯·éšæ—¶æäº¤ Pull Requestã€‚
